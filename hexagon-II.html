<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hexagon</title>

    <style>
        path {
            stroke-width: 5px;
            fill: none;
        }

        svg {
            background-color: black;
        }

    </style>
</head>
<body>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script>

    class Svg {
        static height = 500;
        static width = 960;
        static svg = d3.select("body").append("svg")
            .attr("width", this.width)
            .attr("height", this.height)
            .attr("overflow", "hidden");
    }

    // A single shrinking hexagon
    class Hexagon {
        // Assumes center is at (0,0)
        points = [];
        // Define how the line between the points should look
        lineFunction = d3.line()
            .x(function(d) { return d.x; })
            .y(function(d) {return d.y; });
        path;

        constructor(container, sideLength) {
            this.addPoints(sideLength);
            this.path = container.append("path")
                .attr("d", this.lineFunction(this.points));
        }

        updatePoints(sideLength, opacity) {
            this.points = [];
            this.addPoints(sideLength, opacity);
            this.path.attr("d", this.lineFunction(this.points))
                .attr("stroke", d3.rgb(255*opacity*(2/3), 0, 255*opacity));
        }

        addPoints(sideLength) {
            const angle = Math.PI/3;
            const yShift = sideLength*Math.sin(angle);

            // Calculate the 6 points
            this.points.push({x: sideLength/2, y: -yShift});
            this.points.push({x: sideLength, y: 0});
            this.points.push({x: sideLength/2, y: yShift});
            this.points.push({x: -sideLength/2, y: yShift});
            this.points.push({x: -sideLength, y: 0});
            this.points.push({x: -sideLength/2, y: -yShift});

            // to close the path nicely
            this.points.push(this.points[0]);
            this.points.push(this.points[1]);
        }
    }

    // Holds the group of hexagons all shrinking to the same centre
    class Hexagons {
        defaultSideLength;
        hexagons = [];
        offsets = [];
        constructor(container, sideLength, numHexagons) {
            this.defaultSideLength = sideLength;

            const offset = sideLength/numHexagons;
            for(let i = 0; i < numHexagons; i++) {
                this.offsets.push(i*offset);
                this.hexagons.push(new Hexagon(container, sideLength - this.offsets[i]));
            }
        }

        shiftHexagons(elapsed) {
            for(let i = 0; i < this.hexagons.length; i++) {
                let shift = (elapsed + this.offsets[i]) % this.defaultSideLength;
                let currSideLength = this.defaultSideLength - shift;
                let opacity = 1 - currSideLength/this.defaultSideLength;
                this.hexagons[i].updatePoints(currSideLength, opacity);
            }
        }
    }

    function generateContainers(base, sideLength) {
        let containers = [];
        containers.push(base.append('g'));
        containers.push(base.append('g')
            .attr('transform', 'rotate(30)'));

        // inner circle
        for(let i = 0; i < 6; i++) {
            let degrees = 60*i;
            // inner circle
            containers.push(
                base.append('g')
                    .attr('transform', 'rotate(' + degrees + ') translate(' + sideLength*2 + ',0)')
            );
            containers.push(
                base.append('g')
                    .attr('transform', 'rotate(' + degrees + ') translate(' + sideLength*2 + ',0) rotate(30)')
            )
        }

        return containers;
    }


    // Set up the base on which the animation will be drawn
    const baseTranslate = 'translate(' + Svg.width/2 + ',' + Svg.height/2 + ')';
    let base = Svg.svg.append('g')
        .attr('transform', baseTranslate);

    // Set up the g for each set of hexagons
    const sideLength = 180;
    let containers = generateContainers(base, sideLength);

    const numHexagons = 6;
    let hexagons = [];
    for(let i = 0; i < containers.length; i++) {
        hexagons.push(new Hexagons(containers[i], sideLength, numHexagons));
    }

    // Run the animation
    d3.timer(function(elapsed) {
        const factor = 30;
        let shift = elapsed/factor;
        base.attr('transform', baseTranslate + 'rotate(' + shift + ')');
        for(let i = 0; i < hexagons.length; i++) {
            hexagons[i].shiftHexagons(shift);
        }
    })

</script>

</body>
</html>